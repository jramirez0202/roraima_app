<%# Simple Filters Panel - Solo Tracking Code y Fechas %>
<%# Reutilizable para Customers y Drivers %>

<div class="bg-white rounded-lg shadow mb-6" data-controller="filters-panel" data-filters-panel-expanded-value="false">
  <%# Accordion Header %>
  <button type="button"
          class="w-full px-6 py-4 flex items-center justify-between text-left focus:outline-none focus:ring-2 focus:ring-[#247ba0]"
          data-action="click->filters-panel#toggle">
    <div class="flex items-center">
      <svg class="h-5 w-5 text-gray-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
      </svg>
      <span class="text-lg font-medium text-gray-900">
        Filtros
        <% if local_assigns[:active_filters_count] && active_filters_count > 0 %>
          <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-sky-100 text-[#1d6584]">
            <%= active_filters_count %>
          </span>
        <% end %>
      </span>
    </div>

    <%# Chevron Icon %>
    <svg data-filters-panel-target="chevron"
         class="h-5 w-5 text-gray-500 transition-transform duration-200"
         fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
    </svg>
  </button>

  <%# Collapsible Panel %>
  <div data-filters-panel-target="panel" class="hidden border-t border-gray-200">
    <%= form_with url: local_assigns[:form_url] || request.path, method: :get, data:{ turbo: false, action: "submit->filters-panel#closeOnSubmit" }, class: "px-6 py-4" do |f| %>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <%# Filtro por Estado %>
        <div>
          <%= label_tag :status, "Estado", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <% status_options = local_assigns[:status_options] || status_select_options %>
          <%= select_tag :status,
                         options_for_select(
                           [["Todos los estados", ""]] + status_options,
                           local_assigns[:active_filters]&.dig(:status)
                         ),
                         {
                           class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-[#247ba0] focus:ring-[#247ba0] text-sm"
                         } %>
          <p class="mt-1 text-xs text-gray-500">Filtrar por estado del paquete</p>
        </div>

        <%# Filtro por Tracking Code %>
        <div>
          <%= label_tag :tracking_query, "Código de Seguimiento", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= text_field_tag :tracking_query,
                             local_assigns[:active_filters]&.dig(:tracking_query),
                             {
                               placeholder: "PKG-... o parte del código",
                               class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-[#247ba0] focus:ring-[#247ba0] text-sm",
                               data: { filters_panel_target: "trackingInput" }
                             } %>
          <p class="mt-1 text-xs text-gray-500">Búsqueda parcial, case-insensitive</p>
        </div>

        <%# Filtro por Rango de Fechas %>
        <div>
          <%= label_tag :date_from, "Rango de Fechas", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <div class="space-y-2">
            <%= date_field_tag :date_from,
                               local_assigns[:active_filters]&.dig(:date_from),
                               {
                                 placeholder: "Desde",
                                 class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-[#247ba0] focus:ring-[#247ba0] text-sm"
                               } %>
            <%= date_field_tag :date_to,
                               local_assigns[:active_filters]&.dig(:date_to),
                               {
                                 placeholder: "Hasta",
                                 class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-[#247ba0] focus:ring-[#247ba0] text-sm"
                               } %>
          </div>
          <p class="mt-1 text-xs text-gray-500">
            <br>Especifica rango para cambiar
          </p>
        </div>
      </div>

      <%# Action Buttons %>
      <div class="mt-4 flex items-center justify-between border-t border-gray-200 pt-4">
        <div class="text-sm text-gray-600">
          <% if local_assigns[:pagy] %>
            <%# Usar datos de Pagy para mostrar rango correcto %>
            <% if pagy.count > 0 %>
              Mostrando <span class="font-semibold"><%= pagy.from %>-<%= pagy.to %></span> de <span class="font-semibold"><%= pagy.count %></span> paquete<%= pagy.count != 1 ? 's' : '' %>
            <% else %>
              No hay paquetes
            <% end %>
          <% elsif local_assigns[:filtered_count] && local_assigns[:total_count] %>
            <%# Fallback para vistas que no usan Pagy %>
            <% if filtered_count == total_count %>
              Mostrando <span class="font-semibold"><%= total_count %></span> paquete<%= total_count != 1 ? 's' : '' %>
            <% else %>
              Mostrando <span class="font-semibold"><%= filtered_count %></span> de <span class="font-semibold"><%= total_count %></span> paquetes
            <% end %>
          <% end %>
        </div>

        <div class="flex space-x-3">
          <%= link_to "Limpiar Filtros",
                      local_assigns[:clear_url] || request.path,
                      class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#247ba0]" %>

          <%= button_tag type: "submit",
                         class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#247ba0] hover:bg-[#1d6584] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#247ba0]",
                         data: { filters_panel_target: "submitBtn" } do %>
            <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            Aplicar Filtros
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>
