<div class="px-4 sm:px-0">
  <div class="mb-6">
    <%= link_to(drivers_packages_path(@filter_params), class: "text-blue-600
    hover:text-blue-800 inline-flex items-center") do %>
    <svg
      class="w-5 h-5 mr-1"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M15 19l-7-7 7-7"
      ></path>
    </svg>
    Volver a Mis Paquetes
  <% end %>
  </div>

  <div
    class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden"
  >
    <!-- Encabezado del Paquete -->
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
      <div class="flex justify-between items-start">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">
            Paquete <%= @package.tracking_code %>
          </h1>
        </div>
        <div class="text-right">
          <span
            class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full <%= status_badge_class(@package.status) %>"
          >
            <%= status_text(@package.status) %>
          </span>
          <% if @package.delivered? && @package.delivered_at %>
          <p class="mt-1 text-xs text-gray-600">
            <%= l(@package.delivered_at, format: :short) %>
          </p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n del Destinatario -->
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">
        Informaci√≥n de Entrega
      </h2>
      <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <dt class="text-sm font-medium text-gray-500">Destinatario</dt>
          <dd class="mt-1 text-sm text-gray-900">
            <%= @package.customer_name %>
          </dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Tel√©fono</dt>
          <dd class="mt-1 text-sm text-gray-900">
            <a
              href="tel:<%= @package.phone %>"
              class="text-blue-600 hover:text-blue-800"
            >
              <%= @package.phone %>
            </a>
          </dd>
        </div>
        <div class="sm:col-span-2">
          <dt class="text-sm font-medium text-gray-500">
            Direcci√≥n de Entrega
          </dt>
          <dd class="mt-1 text-sm text-gray-900">
            <%= @package.address %><br />
            <%= @package.commune&.name %>, <%= @package.region&.name %> <% if
            @package.address.present? %>

            <div class="mt-2">
              <% waze_url =
              "https://waze.com/ul?q=#{ERB::Util.url_encode(@package.address +
              ', ' + @package.commune&.name.to_s)}&navigate=yes" %> <%=
              link_to(waze_url, target: "_blank", class: "text-blue-600
              hover:text-blue-800 inline-flex items-center") do %>
              <svg
                class="w-4 h-4 mr-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                ></path>
              </svg>
              Abrir en Waze <% end %>
            </div>
            <% end %>
          </dd>
        </div>
      </dl>
    </div>

    <!-- Informaci√≥n del Paquete -->
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">
        Detalles del Paquete
      </h2>
      <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <dt class="text-sm font-medium text-gray-500">Fecha de Asigancion</dt>
          <dd class="mt-1 text-sm text-gray-900">
            <%= @package.assigned_at&.strftime('%d/%m/%Y %H:%M') || '-' %>
          </dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Monto</dt>
          <dd class="mt-1 text-sm text-gray-900">
            <%= @package.formatted_amount %>
          </dd>
        </div>
        <% if @package.amount > 0 && !@package.delivered? %>
        <div class="sm:col-span-2">
          <dt class="text-sm font-medium text-gray-500 mb-2">M√©todo de Pago</dt>
          <dd class="mt-1">
            <%= form_with url: update_payment_method_drivers_package_path(@package),
                          method: :patch,
                          local: true,
                          data: { turbo: false },
                          class: "inline-flex gap-4" do |f| %>
              <% payment_method_options.each do |option| %>
              <label class="flex items-center gap-2 cursor-pointer">
                <%= f.radio_button :payment_method,
                                   option[:value],
                                   checked: @package.payment_method == option[:value],
                                   onchange: "this.form.submit()",
                                   class: "w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300" %>
                <span class="text-sm font-medium text-gray-900">
                  <%= option[:label] %>
                </span>
              </label>
              <% end %>
            <% end %>
          </dd>
        </div>
        <% elsif @package.amount > 0 && @package.delivered? %>
        <div>
          <dt class="text-sm font-medium text-gray-500">M√©todo de Pago</dt>
          <dd class="mt-1 text-sm text-gray-900">
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= @package.cash? ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800' %>">
              <%= payment_method_text(@package.payment_method) %>
            </span>
          </dd>
        </div>
        <% end %>
        <% if @package.description.present? %>
        <div class="sm:col-span-2">
          <dt class="text-sm font-medium text-gray-500">Descripci√≥n</dt>
          <dd class="mt-1 text-sm text-gray-900">
            <%= @package.description %>
          </dd>
        </div>
        <% end %>
      </dl>
    </div>

    <!-- Detalles del Receptor (solo mostrar cuando ya est√° entregado, para ver datos) -->
    <% if show_receiver_details?(@package) %>
    <div class="px-6 py-4 border-b border-gray-200 bg-green-50">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">
        üë§ Detalles del Receptor
      </h2>
      <dl class="grid grid-cols-1 gap-4">
        <% if @package.receiver_name.present? %>
        <div>
          <dt class="text-sm font-medium text-gray-500">Nombre del Receptor</dt>
          <dd class="mt-1 text-sm text-gray-900 font-semibold"><%= @package.receiver_name %></dd>
        </div>
        <% end %>
        <% if @package.receiver_observations.present? %>
        <div>
          <dt class="text-sm font-medium text-gray-500">Observaciones</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @package.receiver_observations %></dd>
        </div>
        <% end %>
      </dl>
    </div>
    <% end %>

    <!-- Fotos de Evidencia de Entrega (solo mostrar si est√° delivered) -->
    <% if show_proof_photos?(@package) %>
    <div class="px-6 py-4 border-b border-gray-200 bg-green-50">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">
        ‚úÖ Fotos de Evidencia de Entrega
      </h2>
      <%= render 'shared/photo_gallery',
                 photos: @package.proof_photos,
                 modal_function: 'openProofPhotoModal',
                 alt_text: 'Foto de evidencia de entrega' %>
      <p class="mt-2 text-xs text-gray-600">
        <svg
          class="inline w-3 h-3"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
          />
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
          />
        </svg>
        Click en la foto para verla en tama√±o completo
      </p>
    </div>
    <% end %>

    <!-- Informaci√≥n de Reprogramaci√≥n (solo mostrar si est√° rescheduled) -->
    <% if show_reschedule_section?(@package) %>
    <div class="px-6 py-4 border-b border-gray-200 bg-red-50">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">
        ‚ö†Ô∏è Paquete Reprogramado
      </h2>
      <dl class="grid grid-cols-1 gap-4">
        <% if @package.reprogramed_to %>
        <div>
          <dt class="text-sm font-medium text-gray-700">
            Nueva Fecha de Entrega
          </dt>
          <dd class="mt-1 text-sm text-gray-900">
            <%= l(@package.reprogramed_to, format: :long) %>
          </dd>
        </div>
        <% end %> <% if @package.reprogram_motive %>
        <div>
          <dt class="text-sm font-medium text-gray-700">
            Motivo de Reprogramaci√≥n
          </dt>
          <dd class="mt-1">
            <p class="text-base font-bold text-red-600">
              <%= @package.reprogram_motive %>
            </p>
          </dd>
        </div>
        <% end %> <% if show_reschedule_photos?(@package) %>
        <div>
          <dt class="text-sm font-medium text-gray-700 mb-2">
            Fotos de Evidencia
          </dt>
          <dd class="mt-2">
            <%= render 'shared/photo_gallery',
                       photos: @package.reschedule_photos,
                       modal_function: 'openReschedulePhotoModal',
                       alt_text: 'Foto de reprogramaci√≥n' %>
            <p class="mt-2 text-xs text-gray-600">
              <svg
                class="inline w-3 h-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                />
              </svg>
              Click en la foto para verla en tama√±o completo
            </p>
          </dd>
        </div>
        <% end %>
      </dl>
    </div>
    <% end %>

    <!-- Cambio de Estado -->
    <% unless @package.delivered? %>
    <div class="px-6 py-4 bg-gray-50">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">Cambiar Estado</h2>
      <%= form_with url: change_status_drivers_package_path(@package), method:
      :patch, local: true, id: "package-status-form", class: "space-y-4" do |f|
      %>
      <div>
        <%= f.label :new_status, "Selecciona el nuevo estado", class: "block
        text-sm font-medium text-gray-700 mb-3" %>
        <div class="flex flex-wrap gap-4">
          <% status_options = available_status_options_for(@package) %> <% status_options.each do
          |option| %>
          <label class="flex items-center gap-2 cursor-pointer">
            <%= f.radio_button :new_status, option[:value], checked:
            (option[:value] == 'delivered'), onchange:
            "handleStatusChange('#{option[:value]}')", class: "w-5 h-5
            text-blue-600 focus:ring-blue-500 border-gray-300" %>
            <span class="text-base font-medium text-gray-900">
              <%= option[:icon] %> <%= option[:label] %>
            </span>
          </label>
          <% end %>
        </div>
      </div>

      <div id="reason-field" style="display: none">
        <%= f.label :reason, class: "block text-sm font-medium text-gray-700
        mb-1" do %> Motivo (Requerido para Cancelado/Reprogramado)
        <span class="text-xs text-gray-500 font-normal"
          >- M√°ximo 30 caracteres</span
        >
        <% end %> <%= f.text_area :reason, rows: 3, maxlength: 30, class: "mt-1
        block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500
        focus:border-blue-500 sm:text-sm", placeholder: "Ej: Cliente no
        disponible...", required: true, oninput: "updateDriverReasonCounter()"
        %>
        <p class="mt-1 text-xs text-gray-500">
          <span id="driver-reason-counter">0</span>/30 caracteres
        </p>
      </div>

      <!-- Campos del Receptor (Requerido para Entregado) -->
      <div id="receiver-fields" style="display: none">
        <div class="mb-4">
          <%= f.label :receiver_name, class: "block text-sm font-medium text-gray-700 mb-1" do %>
            Nombre del Receptor (Requerido para Entregado)
            <span class="text-xs text-gray-500 font-normal">- M√°ximo 30 caracteres</span>
          <% end %>
          <%= f.text_field :receiver_name,
                           id: "receiver_name",
                           value: @package.receiver_name,
                           maxlength: 30,
                           class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
                           placeholder: "Ej: Juan P√©rez",
                           required: true %>
        </div>

        <div>
          <%= f.label :receiver_observations, class: "block text-sm font-medium text-gray-700 mb-1" do %>
            Observaciones
            <span class="text-xs text-gray-500 font-normal">- Opcional</span>
          <% end %>
          <%= f.text_area :receiver_observations,
                          id: "receiver_observations",
                          value: @package.receiver_observations,
                          rows: 3,
                          class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
                          placeholder: "Ej: Entregado en porter√≠a..." %>
        </div>
      </div>

      <!-- Fotos de evidencia para Entregado -->
      <div
        id="delivery-photos-field"
        style="display: none"
        data-controller="delivery-photos"
        data-delivery-photos-package-id-value="<%= @package.id %>"
        data-delivery-photos-direct-upload-url-value="<%= rails_direct_uploads_url %>"
      >
        <h3 class="text-lg font-semibold text-gray-900 mb-3">
          üì∏ Fotos de Evidencia de Entrega
        </h3>

        <!-- Bot√≥n de captura -->
        <label class="block mb-4">
          <input
            type="file"
            accept="image/*"
            multiple
            data-delivery-photos-target="input"
            data-action="change->delivery-photos#capturePhoto"
            class="hidden"
          />
          <div
            class="w-full cursor-pointer bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 px-6 rounded-lg text-center shadow-lg transform transition hover:scale-105"
          >
            Tomar Foto / Seleccionar de Galer√≠a
          </div>
        </label>

        <!-- Contador -->
        <div
          class="mb-4 p-4 bg-white border-2 border-gray-200 rounded-lg text-center"
        >
          <p
            data-delivery-photos-target="count"
            class="text-lg font-bold text-gray-400"
          >
            0/4 fotos (m√≠n. 2 para activar)
          </p>
        </div>

        <!-- Previews (lista vertical) -->
        <div data-delivery-photos-target="preview" class="space-y-2 mb-4"></div>

        <!-- Estado de upload -->
        <p
          data-delivery-photos-target="status"
          class="hidden mt-2 text-sm text-blue-600 font-medium"
        ></p>

        <!-- Bot√≥n de subir (hidden, se activa desde JS) -->
        <button
          type="button"
          data-delivery-photos-target="submit"
          data-action="click->delivery-photos#uploadPhotos"
          disabled
          class="hidden w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
        >
          ‚òÅÔ∏è Subir Fotos y Continuar
        </button>
      </div>

      <!-- Fotos de evidencia para Reprogramado (Sistema Profesional) -->
      <div
        id="reschedule-photos-field"
        style="display: none"
        data-controller="reschedule-photos"
        data-reschedule-photos-package-id-value="<%= @package.id %>"
        data-reschedule-photos-direct-upload-url-value="<%= rails_direct_uploads_url %>"
      >
        <h3 class="text-lg font-semibold text-gray-900 mb-3">
          üìÖ Fotos de Evidencia de Reprogramaci√≥n
        </h3>

        <!-- Bot√≥n de captura -->
        <label class="block mb-4">
          <input
            type="file"
            accept="image/*"
            multiple
            data-reschedule-photos-target="input"
            data-action="change->reschedule-photos#capturePhoto"
            class="hidden"
          />
          <div
            class="w-full cursor-pointer bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white font-bold py-4 px-6 rounded-lg text-center shadow-lg transform transition hover:scale-105"
          >
            Tomar Foto / Seleccionar de Galer√≠a
          </div>
        </label>

        <!-- Contador -->
        <div
          class="mb-4 p-4 bg-white border-2 border-gray-200 rounded-lg text-center"
        >
          <p
            data-reschedule-photos-target="count"
            class="text-lg font-bold text-gray-400"
          >
            0/4 fotos (m√≠n. 2 para activar)
          </p>
        </div>

        <!-- Previews (lista vertical) -->
        <div
          data-reschedule-photos-target="preview"
          class="space-y-2 mb-4"
        ></div>

        <!-- Estado de upload -->
        <p
          data-reschedule-photos-target="status"
          class="hidden mt-2 text-sm text-blue-600 font-medium"
        ></p>

        <!-- Bot√≥n de subir (hidden, se activa desde JS) -->
        <button
          type="button"
          data-reschedule-photos-target="submit"
          data-action="click->reschedule-photos#uploadPhotos"
          disabled
          class="hidden w-full py-3 bg-orange-600 text-white rounded-lg font-semibold hover:bg-orange-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
        >
          ‚òÅÔ∏è Subir Fotos y Continuar
        </button>
      </div>

      <!-- Fotos de evidencia para Cancelado (Sistema Profesional) -->
      <div
        id="cancelled-photos-field"
        style="display: none"
        data-controller="cancelled-photos"
        data-cancelled-photos-package-id-value="<%= @package.id %>"
        data-cancelled-photos-direct-upload-url-value="<%= rails_direct_uploads_url %>"
      >
        <h3 class="text-lg font-semibold text-gray-900 mb-3">
          ‚ùå Fotos de Evidencia de Cancelaci√≥n
        </h3>

        <!-- Bot√≥n de captura -->
        <label class="block mb-4">
          <input
            type="file"
            accept="image/*"
            multiple
            data-cancelled-photos-target="input"
            data-action="change->cancelled-photos#capturePhoto"
            class="hidden"
          />
          <div
            class="w-full cursor-pointer bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-4 px-6 rounded-lg text-center shadow-lg transform transition hover:scale-105"
          >
            Tomar Foto / Seleccionar de Galer√≠a
          </div>
        </label>

        <!-- Contador -->
        <div
          class="mb-4 p-4 bg-white border-2 border-gray-200 rounded-lg text-center"
        >
          <p
            data-cancelled-photos-target="count"
            class="text-lg font-bold text-gray-400"
          >
            0/4 fotos (m√≠n. 2 para activar)
          </p>
        </div>

        <!-- Previews (lista vertical) -->
        <div
          data-cancelled-photos-target="preview"
          class="space-y-2 mb-4"
        ></div>

        <!-- Estado de upload -->
        <p
          data-cancelled-photos-target="status"
          class="hidden mt-2 text-sm text-blue-600 font-medium"
        ></p>

        <!-- Bot√≥n de subir (hidden, se activa desde JS) -->
        <button
          type="button"
          data-cancelled-photos-target="submit"
          data-action="click->cancelled-photos#uploadPhotos"
          disabled
          class="hidden w-full py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
        >
          ‚òÅÔ∏è Subir Fotos y Continuar
        </button>
      </div>

      <!-- <div>
          <%= f.label :location, "Ubicaci√≥n Actual (Opcional)", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_field :location, class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Ej: En ruta, En casa del cliente, etc." %>
        </div> -->

      <div class="flex gap-3">
        <%= f.submit "Actualizar Estado", id: "update-status-btn", class:
        "flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700
        focus:outline-none focus:ring-2 focus:ring-blue-500" %> <%=
        link_to"Cancelar", drivers_packages_path(@filter_params), class: "px-4
        py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" %>
      </div>
      <% end %>
    </div>
    <% end %>
  </div>
</div>

<!-- Modal para ver fotos de reprogramaci√≥n en tama√±o completo -->
<% if show_reschedule_photos?(@package) %>
<% info_content = capture do %>
  <p class="text-sm text-gray-900">
    <strong>Paquete:</strong> <%= @package.tracking_code %>
    <span class="mx-2">‚Ä¢</span>
    <strong>Receptor:</strong> <%= @package.receiver_name.presence || 'No especificado' %>
    <span class="mx-2">‚Ä¢</span>
    <strong>Estado:</strong> <%= status_text(@package.status) %>
  </p>
  <% if @package.receiver_observations.present? %>
  <p class="text-sm text-gray-700 mt-2">
    <strong>Observaci√≥n:</strong> <%= @package.receiver_observations %>
  </p>
  <% end %>
  <% if @package.reprogramed_to %>
  <p class="text-xs text-gray-600 mt-1">
    Reprogramado para <%= l(@package.reprogramed_to, format: :long) %>
  </p>
  <% end %>
  <% if @package.reprogram_motive %>
  <p class="text-xs font-bold text-red-600 mt-1">
    <strong>Motivo:</strong> <%= @package.reprogram_motive %>
  </p>
  <% end %>
<% end %>

<%= render 'shared/photo_modal',
           modal_id: 'reschedule-photo-view-modal',
           img_id: 'reschedule-photo-view-modal-img',
           close_function: 'closeReschedulePhotoModal',
           alt_text: 'Foto de reprogramaci√≥n',
           info_content: info_content %>

<script>
  function openReschedulePhotoModal(imageUrl) {
    const modal = document.getElementById("reschedule-photo-view-modal");
    const img = document.getElementById("reschedule-photo-view-modal-img");

    // Validar que los elementos existen
    if (!modal || !img) {
      console.warn("Reschedule modal elements not found");
      return;
    }

    img.src = imageUrl;
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeReschedulePhotoModal() {
    const modal = document.getElementById("reschedule-photo-view-modal");
    if (modal) {
      modal.classList.add("hidden");
      document.body.style.overflow = "auto";
    }
  }

  // Contador de caracteres para el campo de raz√≥n
  function updateDriverReasonCounter() {
    const reasonField = document.querySelector("#reason");
    const counter = document.getElementById("driver-reason-counter");
    if (reasonField && counter) {
      counter.textContent = reasonField.value.length;
    }
  }

  // Cerrar con ESC
  document.addEventListener("keydown", function (event) {
    if (event.key === "Escape") {
      closeReschedulePhotoModal();
      closeProofPhotoModal();
    }
  });
</script>
<% end %>

<!-- Modal para ver fotos de evidencia de entrega en tama√±o completo -->
<% if show_proof_photos?(@package) %>
<% info_content = capture do %>
  <p class="text-sm text-gray-900">
    <strong>Paquete:</strong> <%= @package.tracking_code %>
    <span class="mx-2">‚Ä¢</span>
    <strong>Receptor:</strong> <%= @package.receiver_name.presence || 'No especificado' %>
    <span class="mx-2">‚Ä¢</span>
    <strong>Estado:</strong> <%= status_text(@package.status) %>
  </p>
  <% if @package.receiver_observations.present? %>
  <p class="text-sm text-gray-700 mt-2">
    <strong>Observaci√≥n:</strong> <%= @package.receiver_observations %>
  </p>
  <% end %>
  <% if @package.delivered_at %>
  <p class="text-xs text-gray-600 mt-1">
    Entregado el <%= l(@package.delivered_at, format: :long) %>
  </p>
  <% end %>
<% end %>

<%= render 'shared/photo_modal',
           modal_id: 'proof-photo-modal',
           img_id: 'proof-photo-modal-img',
           close_function: 'closeProofPhotoModal',
           alt_text: 'Foto de evidencia de entrega',
           info_content: info_content %>

<script>
  console.log("‚úÖ Proof photo modal script loaded");

  function openProofPhotoModal(imageUrl) {
    console.log("üñºÔ∏è openProofPhotoModal called with:", imageUrl);
    const modal = document.getElementById("proof-photo-modal");
    const img = document.getElementById("proof-photo-modal-img");

    console.log("Modal elements found:", { modal: !!modal, img: !!img });

    // Validar que los elementos existen
    if (!modal || !img) {
      console.error("‚ùå Modal elements not found:", {
        modal: modal ? "found" : "NOT FOUND",
        img: img ? "found" : "NOT FOUND",
      });
      return;
    }

    img.src = imageUrl;
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
    console.log("‚úÖ Modal opened successfully");
  }

  function closeProofPhotoModal() {
    console.log("üö™ Closing proof photo modal");
    const modal = document.getElementById("proof-photo-modal");
    if (modal) {
      modal.classList.add("hidden");
      document.body.style.overflow = "auto";
      console.log("‚úÖ Modal closed");
    }
  }
</script>
<% end %>
