<div class="px-4 sm:px-0">
  <div class="mb-6">
    <%= link_to drivers_packages_path(@filter_params), class: "text-blue-600 hover:text-blue-800 inline-flex items-center" do %>
      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Volver a Mis Paquetes
    <% end %>
  </div>

  <div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden">
    <!-- Encabezado del Paquete -->
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
      <div class="flex justify-between items-start">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Paquete <%= @package.tracking_code %></h1>
        </div>
        <div class="text-right">
          <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full <%= status_badge_class(@package.status) %>">
            <%= status_text(@package.status) %>
          </span>
          <% if @package.delivered? && @package.delivered_at %>
            <p class="mt-1 text-xs text-gray-600">
              <%= l(@package.delivered_at, format: :short) %>
            </p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n del Destinatario -->
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">Informaci√≥n de Entrega</h2>
      <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <dt class="text-sm font-medium text-gray-500">Destinatario</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @package.customer_name %></dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Tel√©fono</dt>
          <dd class="mt-1 text-sm text-gray-900">
            <a href="tel:<%= @package.phone %>" class="text-blue-600 hover:text-blue-800">
              <%= @package.phone %>
            </a>
          </dd>
        </div>
        <div class="sm:col-span-2">
          <dt class="text-sm font-medium text-gray-500">Direcci√≥n de Entrega</dt>
          <dd class="mt-1 text-sm text-gray-900">
            <%= @package.address %><br>
            <%= @package.commune&.name %>, <%= @package.region&.name %>
            <% if @package.address.present? %>
              <div class="mt-2">
                <% maps_url = "https://www.google.com/maps/search/?api=1&query=#{ERB::Util.url_encode(@package.address + ', ' + @package.commune&.name.to_s)}" %>
                <%= link_to maps_url, target: "_blank", class: "text-blue-600 hover:text-blue-800 inline-flex items-center" do %>
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  Abrir en Maps
                <% end %>
              </div>
            <% end %>
          </dd>
        </div>
      </dl>
    </div>

    <!-- Informaci√≥n del Paquete -->
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">Detalles del Paquete</h2>
      <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <dt class="text-sm font-medium text-gray-500">Fecha de Asigancion</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @package.assigned_at&.strftime('%d/%m/%Y %H:%M') || '-' %></dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Monto</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @package.formatted_amount %></dd>
        </div>
        <% if @package.description.present? %>
          <div class="sm:col-span-2">
            <dt class="text-sm font-medium text-gray-500">Descripci√≥n</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @package.description %></dd>
          </div>
        <% end %>
      </dl>
    </div>

    <!-- Detalles del Receptor -->
    <% if @package.in_transit? || @package.rescheduled? || @package.delivered? %>
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">Detalles del Receptor</h2>
        <%= form_with model: @package, url: drivers_package_path(@package), method: :patch, local: true, class: "space-y-4" do |f| %>
          <div>
            <%= f.label :receiver_name, "Nombre del Receptor", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <p class="text-xs text-gray-500 mb-1">Nombre y apellido de quien recibe (m√°ximo 30 caracteres)</p>
            <%= f.text_field :receiver_name,
                             maxlength: 30,
                             class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
                             placeholder: "Ej: Juan P√©rez" %>
          </div>

          <div>
            <%= f.label :receiver_observations, "Observaciones", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <p class="text-xs text-gray-500 mb-1">Cualquier observaci√≥n relevante sobre la entrega</p>
            <%= f.text_area :receiver_observations,
                            rows: 4,
                            class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
                            placeholder: "Ej: El paquete fue entregado en porter√≠a..." %>
          </div>

          <div>
            <%= f.submit "Guardar",
                class: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Fotos de Evidencia de Entrega (solo mostrar si est√° delivered) -->
    <% if @package.proof_photos.attached? && @package.delivered? %>
      <div class="px-6 py-4 border-b border-gray-200 bg-green-50">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">‚úÖ Fotos de Evidencia de Entrega</h2>
        <div class="grid grid-cols-2 gap-2">
          <% @package.proof_photos.each do |photo| %>
            <div class="relative group">
              <%= image_tag photo,
                  class: "w-full h-32 object-cover rounded-lg border border-gray-300 cursor-pointer hover:opacity-90 transition-opacity",
                  onclick: "openProofPhotoModal('#{url_for(photo)}')",
                  alt: "Foto de evidencia de entrega" %>
              <button type="button"
                      onclick="openProofPhotoModal('#{url_for(photo)}')"
                      class="absolute top-1 right-1 bg-white bg-opacity-90 hover:bg-opacity-100 rounded-full p-1 shadow-lg transition-all opacity-0 group-hover:opacity-100">
                <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                </svg>
              </button>
            </div>
          <% end %>
        </div>
        <p class="mt-2 text-xs text-gray-600">
          <svg class="inline w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
          </svg>
          Click en la foto para verla en tama√±o completo
        </p>
      </div>
    <% end %>

    <!-- Informaci√≥n de Reprogramaci√≥n (solo mostrar si est√° rescheduled) -->
    <% if (@package.reprogramed_to || @package.reprogram_motive || @package.reschedule_photos.attached?) && @package.rescheduled? %>
      <div class="px-6 py-4 border-b border-gray-200 bg-red-50">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">‚ö†Ô∏è Paquete Reprogramado</h2>
        <dl class="grid grid-cols-1 gap-4">
          <% if @package.reprogramed_to %>
            <div>
              <dt class="text-sm font-medium text-gray-700">Nueva Fecha de Entrega</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= l(@package.reprogramed_to, format: :long) %></dd>
            </div>
          <% end %>

          <% if @package.reprogram_motive %>
            <div>
              <dt class="text-sm font-medium text-gray-700">Motivo de Reprogramaci√≥n</dt>
              <dd class="mt-1">
                <p class="text-base font-bold text-red-600"><%= @package.reprogram_motive %></p>
              </dd>
            </div>
          <% end %>

          <% if @package.reschedule_photos.attached? %>
            <div>
              <dt class="text-sm font-medium text-gray-700 mb-2">Fotos de Evidencia</dt>
              <dd class="mt-2">
                <div class="grid grid-cols-2 gap-2">
                  <% @package.reschedule_photos.each do |photo| %>
                    <div class="relative group">
                      <%= image_tag photo,
                          class: "w-full h-32 object-cover rounded-lg border border-gray-300 cursor-pointer hover:opacity-90 transition-opacity",
                          onclick: "openReschedulePhotoModal('#{url_for(photo)}')",
                          alt: "Foto de reprogramaci√≥n" %>
                      <button type="button"
                              onclick="openReschedulePhotoModal('#{url_for(photo)}')"
                              class="absolute top-1 right-1 bg-white bg-opacity-90 hover:bg-opacity-100 rounded-full p-1 shadow-lg transition-all opacity-0 group-hover:opacity-100">
                        <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                        </svg>
                      </button>
                    </div>
                  <% end %>
                </div>
                <p class="mt-2 text-xs text-gray-600">
                  <svg class="inline w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                  Click en la foto para verla en tama√±o completo
                </p>
              </dd>
            </div>
          <% end %>
        </dl>
      </div>
    <% end %>


    <!-- Cambio de Estado -->
    <div class="px-6 py-4 bg-gray-50">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">Cambiar Estado</h2>
      <%= form_with url: change_status_drivers_package_path(@package),
                    method: :patch,
                    local: true,
                    id: "package-status-form",
                    class: "space-y-4" do |f| %>
        <div>
          <%= f.label :new_status, "Selecciona el nuevo estado", class: "block text-sm font-medium text-gray-700 mb-3" %>
          <div class="flex flex-wrap gap-4">
            <%
              status_options = [
                { label: 'Entregado', value: 'delivered', icon: '‚úÖ' },
                { label: 'En Camino', value: 'in_transit', icon: 'üöö' },
                { label: 'Reprogramado', value: 'rescheduled', icon: 'üìÖ' },
                { label: 'Cancelado', value: 'cancelled', icon: '‚ùå' } 
              ].reject { |option| option[:value] == @package.status }
            %>

            <% status_options.each do |option| %>
              <label class="flex items-center gap-2 cursor-pointer">
                <%= f.radio_button :new_status,
                    option[:value],
                    checked: (option[:value] == 'delivered'),
                    onchange: "handleStatusChange('#{option[:value]}')",
                    class: "w-5 h-5 text-blue-600 focus:ring-blue-500 border-gray-300" %>
                <span class="text-base font-medium text-gray-900">
                  <%= option[:icon] %> <%= option[:label] %>
                </span>
              </label>
            <% end %>
          </div>
        </div>

        <div id="reason-field" style="display: none;">
          <%= f.label :reason, class: "block text-sm font-medium text-gray-700 mb-1" do %>
            Motivo (Requerido para Cancelado/Reprogramado)
            <span class="text-xs text-gray-500 font-normal">- M√°ximo 30 caracteres</span>
          <% end %>
          <%= f.text_area :reason,
                          rows: 3,
                          maxlength: 30,
                          class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
                          placeholder: "Ej: Cliente no disponible...",
                          required: true,
                          oninput: "updateDriverReasonCounter()" %>
          <p class="mt-1 text-xs text-gray-500">
            <span id="driver-reason-counter">0</span>/30 caracteres
          </p>
        </div>

        <!-- Fotos de evidencia para Entregado (Sistema Profesional) -->
        <div id="delivery-photos-field"
             style="display: none;"
             data-controller="delivery-photos"
             data-delivery-photos-package-id-value="<%= @package.id %>"
             data-delivery-photos-direct-upload-url-value="<%= rails_direct_uploads_url %>">

          <h3 class="text-lg font-semibold text-gray-900 mb-3">
            üì∏ Fotos de Evidencia de Entrega
          </h3>

          <!-- Bot√≥n de captura -->
          <label class="block mb-4">
            <input type="file"
                   accept="image/*"
                   multiple
                   data-delivery-photos-target="input"
                   data-action="change->delivery-photos#capturePhoto"
                   class="hidden">
            <div class="w-full cursor-pointer bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 px-6 rounded-lg text-center shadow-lg transform transition hover:scale-105">
              üì∑ Tomar Foto / üñºÔ∏è Seleccionar de Galer√≠a
            </div>
          </label>

          <!-- Contador -->
          <div class="mb-4 p-4 bg-white border-2 border-gray-200 rounded-lg text-center">
            <p data-delivery-photos-target="count" class="text-lg font-bold text-gray-400">
              0/4 fotos (m√≠n. 2 para activar)
            </p>
          </div>

          <!-- Previews (lista vertical) -->
          <div data-delivery-photos-target="preview"
               class="space-y-2 mb-4">
          </div>

          <!-- Estado de upload -->
          <p data-delivery-photos-target="status" class="hidden mt-2 text-sm text-blue-600 font-medium"></p>

          <!-- Bot√≥n de subir (hidden, se activa desde JS) -->
          <button type="button"
                  data-delivery-photos-target="submit"
                  data-action="click->delivery-photos#uploadPhotos"
                  disabled
                  class="hidden w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
            ‚òÅÔ∏è Subir Fotos y Continuar
          </button>
        </div>

        <!-- Fotos de evidencia para Reprogramado (Sistema Profesional) -->
        <div id="reschedule-photos-field"
             style="display: none;"
             data-controller="reschedule-photos"
             data-reschedule-photos-package-id-value="<%= @package.id %>"
             data-reschedule-photos-direct-upload-url-value="<%= rails_direct_uploads_url %>">

          <h3 class="text-lg font-semibold text-gray-900 mb-3">
            üìÖ Fotos de Evidencia de Reprogramaci√≥n
          </h3>

          <!-- Bot√≥n de captura -->
          <label class="block mb-4">
            <input type="file"
                   accept="image/*"
                   multiple
                   data-reschedule-photos-target="input"
                   data-action="change->reschedule-photos#capturePhoto"
                   class="hidden">
            <div class="w-full cursor-pointer bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white font-bold py-4 px-6 rounded-lg text-center shadow-lg transform transition hover:scale-105">
              üì∑ Tomar Foto / üñºÔ∏è Seleccionar de Galer√≠a
            </div>
          </label>

          <!-- Contador -->
          <div class="mb-4 p-4 bg-white border-2 border-gray-200 rounded-lg text-center">
            <p data-reschedule-photos-target="count" class="text-lg font-bold text-gray-400">
              0/4 fotos (m√≠n. 2 para activar)
            </p>
          </div>

          <!-- Previews (lista vertical) -->
          <div data-reschedule-photos-target="preview"
               class="space-y-2 mb-4">
          </div>

          <!-- Estado de upload -->
          <p data-reschedule-photos-target="status" class="hidden mt-2 text-sm text-blue-600 font-medium"></p>

          <!-- Bot√≥n de subir (hidden, se activa desde JS) -->
          <button type="button"
                  data-reschedule-photos-target="submit"
                  data-action="click->reschedule-photos#uploadPhotos"
                  disabled
                  class="hidden w-full py-3 bg-orange-600 text-white rounded-lg font-semibold hover:bg-orange-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
            ‚òÅÔ∏è Subir Fotos y Continuar
          </button>
        </div>

        <!-- Fotos de evidencia para Cancelado (Sistema Profesional) -->
        <div id="cancelled-photos-field"
             style="display: none;"
             data-controller="cancelled-photos"
             data-cancelled-photos-package-id-value="<%= @package.id %>"
             data-cancelled-photos-direct-upload-url-value="<%= rails_direct_uploads_url %>">

          <h3 class="text-lg font-semibold text-gray-900 mb-3">
            ‚ùå Fotos de Evidencia de Cancelaci√≥n
          </h3>

          <!-- Bot√≥n de captura -->
          <label class="block mb-4">
            <input type="file"
                   accept="image/*"
                   multiple
                   data-cancelled-photos-target="input"
                   data-action="change->cancelled-photos#capturePhoto"
                   class="hidden">
            <div class="w-full cursor-pointer bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-4 px-6 rounded-lg text-center shadow-lg transform transition hover:scale-105">
              üì∑ Tomar Foto / üñºÔ∏è Seleccionar de Galer√≠a
            </div>
          </label>

          <!-- Contador -->
          <div class="mb-4 p-4 bg-white border-2 border-gray-200 rounded-lg text-center">
            <p data-cancelled-photos-target="count" class="text-lg font-bold text-gray-400">
              0/4 fotos (m√≠n. 2 para activar)
            </p>
          </div>

          <!-- Previews (lista vertical) -->
          <div data-cancelled-photos-target="preview"
               class="space-y-2 mb-4">
          </div>

          <!-- Estado de upload -->
          <p data-cancelled-photos-target="status" class="hidden mt-2 text-sm text-blue-600 font-medium"></p>

          <!-- Bot√≥n de subir (hidden, se activa desde JS) -->
          <button type="button"
                  data-cancelled-photos-target="submit"
                  data-action="click->cancelled-photos#uploadPhotos"
                  disabled
                  class="hidden w-full py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
            ‚òÅÔ∏è Subir Fotos y Continuar
          </button>
        </div>

        <!-- <div>
          <%= f.label :location, "Ubicaci√≥n Actual (Opcional)", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_field :location, class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Ej: En ruta, En casa del cliente, etc." %>
        </div> -->

        <div class="flex gap-3">
          <%= f.submit "Actualizar Estado",
              id: "update-status-btn",
              class: "flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          <%= link_to "Cancelar", drivers_packages_path(@filter_params), class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Modal para ver fotos de reprogramaci√≥n en tama√±o completo -->
<% if @package.reschedule_photos.attached? %>
  <div id="reschedule-photo-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Overlay -->
    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="closeReschedulePhotoModal()"></div>

    <!-- Modal Content -->
    <div class="flex min-h-screen items-center justify-center p-4">
      <div class="relative max-w-7xl w-full">
        <!-- Bot√≥n de cerrar -->
        <button type="button"
                onclick="closeReschedulePhotoModal()"
                class="absolute -top-12 right-0 text-white hover:text-gray-300 focus:outline-none">
          <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          <span class="sr-only">Cerrar</span>
        </button>

        <!-- Imagen -->
        <img id="reschedule-photo-modal-img"
             src=""
             alt="Foto de reprogramaci√≥n - Tama√±o completo"
             class="w-full h-auto rounded-lg shadow-2xl"
             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'bg-white p-8 rounded-lg text-center\'><p class=\'text-red-600\'>Error al cargar la imagen</p></div>';">

        <!-- Info adicional -->
        <div class="mt-4 bg-white bg-opacity-90 rounded-lg p-4">
          <p class="text-sm text-gray-900">
            <strong>Paquete:</strong> <%= @package.tracking_code %>
            <span class="mx-2">‚Ä¢</span>
            <strong>Cliente:</strong> <%= @package.customer_name %>
          </p>
          <% if @package.reprogramed_to %>
            <p class="text-xs text-gray-600 mt-1">
              Reprogramado para <%= l(@package.reprogramed_to, format: :long) %>
            </p>
          <% end %>
          <% if @package.reprogram_motive %>
            <p class="text-xs font-bold text-red-600 mt-1">
              <%= @package.reprogram_motive %>
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <script>
    function openReschedulePhotoModal(imageUrl) {
      const modal = document.getElementById('reschedule-photo-modal');
      const img = document.getElementById('reschedule-photo-modal-img');

      // Validar que los elementos existen
      if (!modal || !img) {
        console.warn('Reschedule modal elements not found');
        return;
      }

      img.src = imageUrl;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeReschedulePhotoModal() {
      const modal = document.getElementById('reschedule-photo-modal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
      }
    }

    // Contador de caracteres para el campo de raz√≥n
    function updateDriverReasonCounter() {
      const reasonField = document.querySelector('#reason');
      const counter = document.getElementById('driver-reason-counter');
      if (reasonField && counter) {
        counter.textContent = reasonField.value.length;
      }
    }

    // Cerrar con ESC
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeReschedulePhotoModal();
        closeProofPhotoModal();
      }
    });
  </script>
<% end %>

<!-- Modal para ver fotos de evidencia de entrega en tama√±o completo -->
<% if @package.proof_photos.attached? %>
  <div id="proof-photo-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Overlay -->
    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="closeProofPhotoModal()"></div>

    <!-- Modal Content -->
    <div class="flex min-h-screen items-center justify-center p-4">
      <div class="relative max-w-7xl w-full">
        <!-- Bot√≥n de cerrar -->
        <button type="button"
                onclick="closeProofPhotoModal()"
                class="absolute -top-12 right-0 text-white hover:text-gray-300 focus:outline-none">
          <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          <span class="sr-only">Cerrar</span>
        </button>

        <!-- Imagen -->
        <img id="proof-photo-modal-img"
             src=""
             alt="Foto de evidencia de entrega - Tama√±o completo"
             class="w-full h-auto rounded-lg shadow-2xl"
             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'bg-white p-8 rounded-lg text-center\'><p class=\'text-red-600\'>Error al cargar la imagen</p></div>';">

        <!-- Info adicional -->
        <div class="mt-4 bg-white bg-opacity-90 rounded-lg p-4">
          <p class="text-sm text-gray-900">
            <strong>Paquete:</strong> <%= @package.tracking_code %>
            <span class="mx-2">‚Ä¢</span>
            <strong>Cliente:</strong> <%= @package.customer_name %>
            <span class="mx-2">‚Ä¢</span>
            <strong>Estado:</strong> <%= status_text(@package.status) %>
          </p>
          <% if @package.delivered_at %>
            <p class="text-xs text-gray-600 mt-1">
              Entregado el <%= l(@package.delivered_at, format: :long) %>
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <script>
    console.log('‚úÖ Proof photo modal script loaded');

    function openProofPhotoModal(imageUrl) {
      console.log('üñºÔ∏è openProofPhotoModal called with:', imageUrl);
      const modal = document.getElementById('proof-photo-modal');
      const img = document.getElementById('proof-photo-modal-img');

      console.log('Modal elements found:', { modal: !!modal, img: !!img });

      // Validar que los elementos existen
      if (!modal || !img) {
        console.error('‚ùå Modal elements not found:', {
          modal: modal ? 'found' : 'NOT FOUND',
          img: img ? 'found' : 'NOT FOUND'
        });
        return;
      }

      img.src = imageUrl;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      console.log('‚úÖ Modal opened successfully');
    }

    function closeProofPhotoModal() {
      console.log('üö™ Closing proof photo modal');
      const modal = document.getElementById('proof-photo-modal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        console.log('‚úÖ Modal closed');
      }
    }
  </script>
<% end %>
