<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header con navegaci√≥n -->
  <div class="mb-6">
    <%= link_to admin_packages_path(@filter_params), class: "inline-flex items-center text-sm text-gray-500 hover:text-gray-700" do %>
      <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Volver a Paquetes
    <% end %>
  </div>

  <!-- T√≠tulo y Estado Principal -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex justify-between items-start">
        <div>
          <div class="flex items-center gap-3">
            <h1 class="text-2xl font-bold text-gray-900">Paquete #<%= @package.tracking_code %></h1>
            <div class="inline-flex flex-col items-start">
              <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full <%= status_badge_classes(@package.status) %>">
                <%= status_text(@package.status) %>
              </span>
              <% if @package.delivered? && @package.delivered_at %>
                <span class="mt-1 text-xs text-gray-600 pl-3">
                  <%= l(@package.delivered_at, format: :short) %>
                </span>
              <% end %>
            </div>
          </div>
          <p class="mt-2 text-sm text-gray-600">
            Cliente: <span class="font-medium"><%= @package.customer_name %></span>
          </p>
        </div>
        <div class="flex gap-2">
          <% unless @package.terminal? %>
            <%= link_to edit_admin_package_path(@package), class: "inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" do %>
              <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
              Editar
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Columna Izquierda: Detalles y Formularios -->
    <div class="lg:col-span-2 space-y-6">

      <!-- Tracking Info Card -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Informaci√≥n de Tracking</h2>
        </div>
        <div class="px-6 py-4">
          <dl class="grid grid-cols-2 gap-4">
            <div>
              <dt class="text-xs font-medium text-gray-500 uppercase">C√≥digo de Tracking</dt>
              <dd class="mt-1 text-sm font-mono font-semibold text-gray-900"><%= @package.tracking_code %></dd>
            </div>
            <div>
              <dt class="text-xs font-medium text-gray-500 uppercase">Courier Asignado</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <% if @package.assigned_courier %>
                  <%= @package.assigned_courier.name %>
                <% else %>
                  <span class="text-gray-400">Sin asignar</span>
                <% end %>
              </dd>
            </div>
            <% if @package.shipped_at %>
              <div>
                <dt class="text-xs font-medium text-gray-500 uppercase">En Camino desde</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= l(@package.shipped_at, format: :long) %></dd>
              </div>
            <% end %>
            <% if @package.delivered_at %>
              <div>
                <dt class="text-xs font-medium text-gray-500 uppercase">Entregado el</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= l(@package.delivered_at, format: :long) %></dd>
              </div>
            <% end %>
            <% if @package.reprogramed_to %>
              <div>
                <dt class="text-xs font-medium text-gray-500 uppercase">Reprogramado para</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= l(@package.reprogramed_to, format: :long) %></dd>
              </div>
            <% end %>
          </dl>
        </div>
      </div>

      <!-- Detalles del Paquete -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Detalles del Paquete</h2>
        </div>
        <div class="px-6 py-4">
          <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
            <div class="sm:col-span-1">
              <dt class="text-sm font-medium text-gray-500">Nombre del Cliente</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @package.customer_name %></dd>
            </div>

            <div class="sm:col-span-1">
              <dt class="text-sm font-medium text-gray-500">Email Remitente</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @package.sender_email.presence || '‚Äî' %></dd>
            </div>

            <div class="sm:col-span-1">
              <dt class="text-sm font-medium text-gray-500">Empresa</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @package.company_name.presence || '‚Äî' %></dd>
            </div>

            <div class="sm:col-span-2">
              <dt class="text-sm font-medium text-gray-500">Direcci√≥n</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @package.address %></dd>
            </div>

            <div class="sm:col-span-1">
              <dt class="text-sm font-medium text-gray-500">Comuna</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @package.commune&.name || '‚Äî' %></dd>
            </div>

            <div class="sm:col-span-1">
              <dt class="text-sm font-medium text-gray-500">Tel√©fono</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <% if @package.phone.present? %>
                  <a href="tel:<%= @package.phone %>" class="text-indigo-600 hover:text-indigo-900"><%= @package.phone %></a>
                <% else %>
                  ‚Äî
                <% end %>
              </dd>
            </div>

            <div class="sm:col-span-1">
              <dt class="text-sm font-medium text-gray-500">Fecha de Carga</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= l(@package.loading_date, format: :long) if @package.loading_date %></dd>
            </div>

            <div class="sm:col-span-1">
              <dt class="text-sm font-medium text-gray-500">Intercambio</dt>
              <dd class="mt-1">
                <% if @package.exchange %>
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">S√≠</span>
                <% else %>
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">No</span>
                <% end %>
              </dd>
            </div>

            <div class="sm:col-span-1">
              <dt class="text-sm font-medium text-gray-500">Monto</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @package.formatted_amount %></dd>
            </div>

            <% if @package.amount > 0 %>
            <div class="sm:col-span-1">
              <dt class="text-sm font-medium text-gray-500">M√©todo de Pago</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= @package.cash? ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800' %>">
                  <%= payment_method_text(@package.payment_method) %>
                </span>
              </dd>
            </div>
            <% end %>

            <div class="sm:col-span-2">
              <dt class="text-sm font-medium text-gray-500">Descripci√≥n</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @package.description.presence || '‚Äî' %></dd>
            </div>

            <%# Detalles del Receptor %>
            <% if @package.receiver_name.present? || @package.receiver_observations.present? %>
              <div class="sm:col-span-2 border-t border-gray-200 pt-4">
                <h3 class="text-base font-semibold text-gray-900 mb-4">üìã Detalles del Receptor</h3>

                <% if @package.receiver_name.present? %>
                  <div class="mb-3">
                    <dt class="text-sm font-medium text-gray-500 mb-1">Nombre del Receptor</dt>
                    <dd class="mt-1">
                      <p class="text-base font-semibold text-gray-900"><%= @package.receiver_name %></p>
                    </dd>
                  </div>
                <% end %>

                <% if @package.receiver_observations.present? %>
                  <div>
                    <dt class="text-sm font-medium text-gray-500 mb-1">Observaciones</dt>
                    <dd class="mt-1">
                      <p class="text-sm text-gray-900 whitespace-pre-wrap"><%= @package.receiver_observations %></p>
                    </dd>
                  </div>
                <% end %>
              </div>
            <% end %>

            <%# Informaci√≥n de Reprogramaci√≥n - Solo mostrar si est√° rescheduled %>
            <% if (@package.reprogram_motive.present? || @package.reschedule_photos.attached?) && @package.rescheduled? %>
              <div class="sm:col-span-2 border-t border-gray-200 pt-4">
                <h3 class="text-base font-semibold text-gray-900 mb-4">‚ö†Ô∏è Informaci√≥n de Reprogramaci√≥n</h3>

                <% if @package.reprogram_motive.present? %>
                  <div class="mb-4">
                    <dt class="text-sm font-medium text-gray-500 mb-1">Motivo de Reprogramaci√≥n</dt>
                    <dd class="mt-1">
                      <p class="text-base font-bold text-red-600"><%= @package.reprogram_motive %></p>
                    </dd>
                  </div>
                <% end %>

                <% if @package.reschedule_photos.attached? %>
                  <div>
                    <dt class="text-sm font-medium text-gray-500 mb-2">Fotos de Evidencia</dt>
                    <dd class="mt-2">
                      <div class="grid grid-cols-2 gap-3">
                        <% @package.reschedule_photos.each do |photo| %>
                          <div class="relative group">
                            <%= image_tag photo,
                                class: "w-full h-32 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:opacity-90 hover:border-indigo-500 transition-all",
                                onclick: "openReschedulePhotoModal('#{url_for(photo)}')",
                                alt: "Foto de reprogramaci√≥n" %>
                            <button type="button"
                                    onclick="openReschedulePhotoModal('#{url_for(photo)}')"
                                    class="absolute top-2 right-2 bg-white bg-opacity-90 hover:bg-opacity-100 rounded-full p-1.5 shadow-lg transition-all opacity-0 group-hover:opacity-100">
                              <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                              </svg>
                            </button>
                          </div>
                        <% end %>
                      </div>
                      <p class="mt-2 text-xs text-gray-500">
                        <svg class="inline w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        Click en la foto para verla en tama√±o completo
                      </p>
                    </dd>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Fotos de Evidencia de Entrega (Active Storage) - Solo mostrar si est√° delivered -->
            <% if @package.proof_photos.attached? && @package.delivered? %>
              <div class="sm:col-span-2">
                <dt class="text-sm font-medium text-gray-500 mb-2">üì∏ Fotos de Entrega</dt>
                <dd class="mt-1">
                  <div class="grid grid-cols-2 gap-2">
                    <% @package.proof_photos.each do |photo| %>
                      <div class="relative group">
                        <%= image_tag photo,
                            class: "w-full h-32 object-cover rounded-lg border border-gray-300 cursor-pointer hover:opacity-90 transition-opacity",
                            onclick: "openProofPhotoModal('#{url_for(photo)}')",
                            alt: "Foto de evidencia de entrega" %>
                        <button type="button"
                                onclick="openProofPhotoModal('#{url_for(photo)}')"
                                class="absolute top-1 right-1 bg-white bg-opacity-90 hover:bg-opacity-100 rounded-full p-1 shadow-lg transition-all opacity-0 group-hover:opacity-100">
                          <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                          </svg>
                        </button>
                      </div>
                    <% end %>
                  </div>
                  <p class="mt-2 text-xs text-gray-500">
                    <svg class="inline w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Click en la foto para verla en tama√±o completo
                  </p>
                </dd>
              </div>
            <% end %>

            <% if @package.proof.present? %>
              <div class="sm:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Prueba de Entrega (Legacy)</dt>
                <dd class="mt-1">
                  <%
                    is_image = @package.proof.start_with?('data:image') ||
                               @package.proof.start_with?('http://') ||
                               @package.proof.start_with?('https://')
                  %>
                  <% if is_image %>
                    <div class="relative inline-block">
                      <img src="<%= @package.proof %>"
                           alt="Prueba de entrega"
                           onclick="openProofModal()"
                           class="max-w-md max-h-96 rounded-lg shadow-lg border border-gray-200 cursor-pointer hover:opacity-90 transition-opacity"
                           onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%23f3f4f6%22 width=%22400%22 height=%22300%22/%3E%3Ctext fill=%22%239ca3af%22 font-family=%22Arial%22 font-size=%2216%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22%3EError al cargar imagen%3C/text%3E%3C/svg%3E';">
                      <button type="button"
                              onclick="openProofModal()"
                              class="absolute top-2 right-2 bg-white bg-opacity-90 hover:bg-opacity-100 rounded-full p-2 shadow-lg transition-all">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                        </svg>
                      </button>
                      <p class="mt-2 text-xs text-gray-500">
                        <svg class="inline w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        Click para ver en tama√±o completo
                      </p>
                    </div>
                  <% else %>
                    <div class="text-sm text-gray-900 whitespace-pre-wrap"><%= @package.proof %></div>
                  <% end %>
                </dd>
              </div>
            <% end %>
          </dl>
        </div>
      </div>

      <!-- Formularios de Cambio de Estado -->
      <% unless @package.terminal? %>
        <div class="bg-white shadow rounded-lg">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Cambiar Estado del Paquete</h2>
            <p class="mt-1 text-sm text-gray-500">
              Estado actual: <span class="font-medium text-gray-900"><%= status_text(@package.status) %></span>
            </p>
          </div>

          <!-- Flujo com√∫n de estados (ayuda visual) -->
          <% if @package.pending_pickup? %>
            <div class="px-6 py-3 bg-blue-50 border-b border-blue-100">
              <div class="flex items-start">
                <svg class="h-5 w-5 text-blue-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-blue-800">Siguiente paso sugerido:</h3>
                  <p class="mt-1 text-sm text-blue-700">
                    Cambiar a <strong>"Bodega"</strong> cuando el paquete llegue a la bodega de distribuci√≥n (manualmente o al escanear QR con pistola).
                  </p>
                </div>
              </div>
            </div>
          <% elsif @package.in_warehouse? %>
            <div class="px-6 py-3 bg-blue-50 border-b border-blue-100">
              <div class="flex items-start">
                <svg class="h-5 w-5 text-blue-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-blue-800">Siguiente paso sugerido:</h3>
                  <p class="mt-1 text-sm text-blue-700">
                    Asignar un conductor abajo y cambiar a <strong>"En Camino"</strong> cuando salga para entrega.
                  </p>
                </div>
              </div>
            </div>
          <% end %>

          <div class="px-6 py-4" data-controller="package-status">
            <%= form_with url: change_status_admin_package_path(@package), method: :patch, local: true, data: { package_status_target: "form", action: "submit->package-status#validateForm" } do |f| %>

              <!-- Selecci√≥n de nuevo estado -->
              <div class="mb-4">
                <label for="new_status" class="block text-sm font-medium text-gray-700 mb-2">Nuevo Estado</label>
                <select name="new_status" id="new_status"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        data-package-status-target="statusSelect"
                        data-action="change->package-status#toggleFields"
                        required>
                  <option value="">Seleccionar estado...</option>
                  <% Package::ALLOWED_TRANSITIONS[@package.status.to_sym]&.each do |allowed_status| %>
                    <option value="<%= allowed_status %>"><%= status_text(allowed_status) %></option>
                  <% end %>
                </select>
              </div>

              <!-- Motivo del cambio -->
              <div class="mb-4" data-package-status-target="reasonField" style="display: none;">
                <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">
                  Motivo del Cambio (Requerido para Devoluci√≥n/Reprogramado)
                  <span class="text-xs text-gray-500 font-normal">- M√°ximo 30 caracteres</span>
                </label>
                <textarea name="reason" id="reason" rows="3"
                          maxlength="30"
                          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                          placeholder="Ej: Cliente no disponible..."
                          oninput="updateReasonCounter()"></textarea>
                <p class="mt-1 text-xs text-gray-500">
                  <span id="reason-counter">0</span>/30 caracteres
                </p>
              </div>

              <!-- Ubicaci√≥n -->
              <div class="mb-4">
                <label for="location" class="block text-sm font-medium text-gray-700 mb-2">Ubicaci√≥n Actual</label>
                <input type="text" name="location" id="location"
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                       placeholder="Ej: Bodega Central, En camino a Las Condes...">
                <div id="location-suggestions" class="mt-2 text-xs text-gray-500 hidden">
                  <span class="font-medium">Sugerencias r√°pidas:</span>
                  <button type="button" onclick="document.getElementById('location').value='Bodega Central'" class="ml-2 text-indigo-600 hover:text-indigo-800">Bodega Central</button> |
                  <button type="button" onclick="document.getElementById('location').value='Bodega de Distribuci√≥n'" class="ml-1 text-indigo-600 hover:text-indigo-800">Bodega de Distribuci√≥n</button>
                </div>
              </div>

              <!-- Campos espec√≠ficos para ciertos estados -->
              <div id="en-camino-fields" class="hidden mb-4">
                <label for="courier_id" class="block text-sm font-medium text-gray-700 mb-2">
                  Asignar/Cambiar Driver
                  <% if @package.assigned_courier %>
                    <span class="text-xs text-gray-500">(Actual: <%= @package.assigned_courier.name %>)</span>
                  <% end %>
                </label>
                <select name="courier_id" id="courier_id"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                  <option value="">Seleccionar driver...</option>
                  <% @couriers.each do |courier| %>
                    <option value="<%= courier.id %>" <%= 'selected' if @package.assigned_courier_id == courier.id %>>
                      <%= courier.name %><%= " (#{courier.vehicle_model})" if courier.respond_to?(:vehicle_model) && courier.vehicle_model.present? %>
                    </option>
                  <% end %>
                </select>
                <p class="mt-1 text-xs text-gray-500">
                  <% if @package.assigned_courier %>
                    ‚ö†Ô∏è Al cambiar el driver, el anterior (<%= @package.assigned_courier.name %>) quedar√° registrado en el historial.
                  <% else %>
                    Debe asignar un driver para marcar como "En Camino"
                  <% end %>
                </p>
              </div>

              <!-- Campo de Fotos de Evidencia (para "Entregado") -->
              <div class="mb-4" data-package-status-target="proofField" style="display: none;">
                <label for="proof_photos" class="block text-sm font-medium text-gray-700 mb-2">Fotos de Entrega (Min 2)</label>
                <input type="file"
                       name="proof_photos[]"
                       id="proof_photos"
                       accept="image/*"
                       capture="environment"
                       multiple
                       class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-md file:border-0
                              file:text-sm file:font-medium
                              file:bg-indigo-50 file:text-indigo-700
                              hover:file:bg-indigo-100">
                <p class="mt-2 text-xs text-gray-500">
                  üì∏ hasta 4 fotos de entrega
                </p>
              </div>

              <div id="reprogramado-fields" class="hidden space-y-4 mb-4">
                <div>
                  <label for="reprogram_date" class="block text-sm font-medium text-gray-700 mb-2">Nueva Fecha de Entrega</label>
                  <input type="datetime-local" name="reprogram_date" id="reprogram_date"
                         class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                  <label for="motive" class="block text-sm font-medium text-gray-700 mb-2">
                    Motivo de Reprogramaci√≥n (Requerido)
                    <span class="text-xs text-gray-500 font-normal">- M√°ximo 30 caracteres</span>
                  </label>
                  <textarea name="motive" id="motive" rows="2"
                            maxlength="30"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                            placeholder="Ej: Cliente no disponible..."
                            oninput="updateMotiveCounter()"></textarea>
                  <p class="mt-1 text-xs text-gray-500">
                    <span id="motive-counter">0</span>/30 caracteres
                  </p>
                </div>
                <div>
                  <label for="reschedule_photos" class="block text-sm font-medium text-gray-700 mb-2">Fotos de Entrega</label>
                  <input type="file"
                         name="reschedule_photos[]"
                         id="reschedule_photos"
                         accept="image/*"
                         capture="environment"
                         multiple
                         class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-md file:border-0
                                file:text-sm file:font-medium
                                file:bg-indigo-50 file:text-indigo-700
                                hover:file:bg-indigo-100">
                  <p class="mt-1 text-xs text-gray-500">Puedes seleccionar m√∫ltiples fotos para adjuntar evidencia de la reprogramaci√≥n</p>
                </div>
              </div>

              <!-- Override para admin -->
              <% if policy(@package).override_transition? %>
                <div class="mb-4">
                  <label class="flex items-center">
                    <input type="checkbox" name="override" value="true"
                           class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <span class="ml-2 text-sm text-gray-700">
                      Forzar transici√≥n (Admin Override)
                      <span class="text-xs text-gray-500">- Permite cambios no permitidos normalmente</span>
                    </span>
                  </label>
                </div>
              <% end %>

              <div class="flex gap-2">
                <%= f.submit "Cambiar Estado", class: "inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Asignar Courier -->
        <% if @package.assigned_courier.nil? %>
          <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-900">Asignar Courier</h2>
            </div>
            <div class="px-6 py-4">
              <%= form_with url: assign_courier_admin_package_path(@package), method: :patch, local: true do |f| %>
                <div class="mb-4">
                  <label for="courier_id" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Courier</label>
                  <select name="courier_id" id="courier_id"
                          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                          required>
                    <option value="">Seleccionar...</option>
                    <% @couriers.each do |courier| %>
                      <option value="<%= courier.id %>"><%= courier.name %><%= " (#{courier.vehicle_model})" if courier.vehicle_model.present? %></option>
                    <% end %>
                  </select>
                </div>
                <%= f.submit "Asignar Courier", class: "inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700" %>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>

    </div>

    <!-- Columna Derecha: Timeline de Estados -->
    <div class="lg:col-span-1">
      <div class="bg-white shadow rounded-lg sticky top-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Historial de Estados</h2>
        </div>
        <div class="px-6 py-4">
          <% if @package.status_history.present? %>
            <div class="flow-root">
              <ul role="list" class="-mb-8">
                <% @package.status_history.reverse.each_with_index do |entry, index| %>
                  <li>
                    <div class="relative pb-8">
                      <% unless index == @package.status_history.length - 1 %>
                        <span class="absolute left-4 top-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                      <% end %>
                      <div class="relative flex space-x-3">
                        <div>
                          <span class="h-8 w-8 rounded-full <%= status_badge_classes(entry['status']) %> flex items-center justify-center ring-8 ring-white">
                            <% case entry['status'] %>
                            <% when 'delivered' %>
                              <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                              </svg>
                            <% when 'cancelled', 'return' %>
                              <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                              </svg>
                            <% else %>
                              <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                              </svg>
                            <% end %>
                          </span>
                        </div>
                        <div class="flex min-w-0 flex-1 justify-between space-x-4 pt-1.5">
                          <div>
                            <p class="text-sm font-medium text-gray-900">
                              <%= status_text(entry['status']) %>
                              <% if entry['override'] %>
                                <span class="ml-1 text-xs text-orange-600">(Override)</span>
                              <% end %>
                            </p>
                            <% if entry['reason'].present? %>
                              <p class="mt-0.5 text-xs text-gray-500"><%= entry['reason'] %></p>
                            <% end %>
                            <% if entry['location'].present? %>
                              <p class="mt-0.5 text-xs text-gray-400">
                                <svg class="inline h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <%= entry['location'] %>
                              </p>
                            <% end %>
                          </div>
                          <div class="whitespace-nowrap text-right text-xs text-gray-500">
                            <%= Time.parse(entry['timestamp']).strftime('%d/%m/%y %H:%M') rescue entry['timestamp'] %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </li>
                <% end %>
              </ul>
            </div>
          <% else %>
            <p class="text-sm text-gray-500">No hay historial de cambios de estado disponible.</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para ver imagen en tama√±o completo -->
<% if @package.proof.present? && (@package.proof.start_with?('data:image') || @package.proof.start_with?('http://') || @package.proof.start_with?('https://')) %>
  <div id="proof-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Overlay -->
    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="closeProofModal()"></div>

    <!-- Modal Content -->
    <div class="flex min-h-screen items-center justify-center p-4">
      <div class="relative max-w-7xl w-full">
        <!-- Bot√≥n de cerrar -->
        <button type="button"
                onclick="closeProofModal()"
                class="absolute -top-12 right-0 text-white hover:text-gray-300 focus:outline-none">
          <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          <span class="sr-only">Cerrar</span>
        </button>

        <!-- Imagen -->
        <img src="<%= @package.proof %>"
             alt="Prueba de entrega - Tama√±o completo"
             class="w-full h-auto rounded-lg shadow-2xl"
             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'bg-white p-8 rounded-lg text-center\'><p class=\'text-red-600\'>Error al cargar la imagen</p></div>';">

        <!-- Info adicional -->
        <div class="mt-4 bg-white bg-opacity-90 rounded-lg p-4">
          <p class="text-sm text-gray-900">
            <strong>Paquete:</strong> <%= @package.tracking_code %>
            <span class="mx-2">‚Ä¢</span>
            <strong>Cliente:</strong> <%= @package.customer_name %>
          </p>
          <% if @package.delivered_at %>
            <p class="text-xs text-gray-600 mt-1">
              Entregado el <%= l(@package.delivered_at, format: :long) %>
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <script>
    function openProofModal() {
      document.getElementById('proof-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeProofModal() {
      document.getElementById('proof-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Contadores de caracteres
    function updateReasonCounter() {
      const reasonField = document.getElementById('reason');
      const counter = document.getElementById('reason-counter');
      if (reasonField && counter) {
        counter.textContent = reasonField.value.length;
      }
    }

    function updateMotiveCounter() {
      const motiveField = document.getElementById('motive');
      const counter = document.getElementById('motive-counter');
      if (motiveField && counter) {
        counter.textContent = motiveField.value.length;
      }
    }

    // Cerrar con ESC
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeProofModal();
        closeProofPhotoModal();
        closeReschedulePhotoModal();
      }
    });
  </script>
<% end %>

<!-- Modal para ver fotos de reprogramaci√≥n en tama√±o completo -->
<% if @package.reschedule_photos.attached? %>
  <div id="reschedule-photo-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Overlay -->
    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="closeReschedulePhotoModal()"></div>

    <!-- Modal Content -->
    <div class="flex min-h-screen items-center justify-center p-4">
      <div class="relative max-w-7xl w-full">
        <!-- Bot√≥n de cerrar -->
        <button type="button"
                onclick="closeReschedulePhotoModal()"
                class="absolute -top-12 right-0 text-white hover:text-gray-300 focus:outline-none">
          <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          <span class="sr-only">Cerrar</span>
        </button>

        <!-- Imagen -->
        <img id="reschedule-photo-modal-img"
             src=""
             alt="Foto de reprogramaci√≥n - Tama√±o completo"
             class="w-full h-auto rounded-lg shadow-2xl">

        <!-- Info adicional -->
        <div class="mt-4 bg-white bg-opacity-90 rounded-lg p-4">
          <p class="text-sm text-gray-900">
            <strong>Paquete:</strong> <%= @package.tracking_code %>
            <span class="mx-2">‚Ä¢</span>
            <strong>Receptor:</strong> <%= @package.receiver_name.presence || 'No especificado' %>
            <span class="mx-2">‚Ä¢</span>
            <strong>Estado:</strong> <%= status_text(@package.status) %>
          </p>
          <% if @package.receiver_observations.present? %>
            <p class="text-sm text-gray-700 mt-2">
              <strong>Observaci√≥n:</strong> <%= @package.receiver_observations %>
            </p>
          <% end %>
          <% if @package.reprogramed_to %>
            <p class="text-xs text-gray-600 mt-1">
              Reprogramado para <%= l(@package.reprogramed_to, format: :long) %>
            </p>
          <% end %>
          <% if @package.reprogram_motive %>
            <p class="text-xs font-bold text-red-600 mt-1">
              <strong>Motivo:</strong> <%= @package.reprogram_motive %>
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <script>
    function openReschedulePhotoModal(imageUrl) {
      const modal = document.getElementById('reschedule-photo-modal');
      const img = document.getElementById('reschedule-photo-modal-img');
      img.src = imageUrl;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeReschedulePhotoModal() {
      document.getElementById('reschedule-photo-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Cerrar con ESC
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeReschedulePhotoModal();
        closeProofPhotoModal();
      }
    });
  </script>
<% end %>

<!-- Modal para ver fotos de evidencia de entrega en tama√±o completo -->
<% if @package.proof_photos.attached? %>
  <div id="proof-photo-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Overlay -->
    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="closeProofPhotoModal()"></div>

    <!-- Modal Content -->
    <div class="flex min-h-screen items-center justify-center p-4">
      <div class="relative max-w-7xl w-full">
        <!-- Bot√≥n de cerrar -->
        <button type="button"
                onclick="closeProofPhotoModal()"
                class="absolute -top-12 right-0 text-white hover:text-gray-300 focus:outline-none">
          <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          <span class="sr-only">Cerrar</span>
        </button>

        <!-- Imagen -->
        <img id="proof-photo-modal-img"
             src=""
             alt="Foto de evidencia de entrega - Tama√±o completo"
             class="w-full h-auto rounded-lg shadow-2xl">

        <!-- Info adicional -->
        <div class="mt-4 bg-white bg-opacity-90 rounded-lg p-4">
          <p class="text-sm text-gray-900">
            <strong>Paquete:</strong> <%= @package.tracking_code %>
            <span class="mx-2">‚Ä¢</span>
            <strong>Receptor:</strong> <%= @package.receiver_name.presence || 'No especificado' %>
            <span class="mx-2">‚Ä¢</span>
            <strong>Estado:</strong> <%= status_text(@package.status) %>
          </p>
          <% if @package.receiver_observations.present? %>
            <p class="text-sm text-gray-700 mt-2">
              <strong>Observaci√≥n:</strong> <%= @package.receiver_observations %>
            </p>
          <% end %>
          <% if @package.delivered_at %>
            <p class="text-xs text-gray-600 mt-1">
              Entregado el <%= l(@package.delivered_at, format: :long) %>
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <script>
    function openProofPhotoModal(imageUrl) {
      const modal = document.getElementById('proof-photo-modal');
      const img = document.getElementById('proof-photo-modal-img');
      img.src = imageUrl;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeProofPhotoModal() {
      const modal = document.getElementById('proof-photo-modal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
      }
    }
  </script>
<% end %>
